name: Deploy para HomologaÃ§Ã£o

on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Pular testes (use com cautela)'
        required: false
        type: boolean
        default: false

jobs:
  deploy-hml:
    name: Deploy para HML
    runs-on: ubuntu-latest
    environment:
      name: homologation
      url: https://hml.obreirovirtual.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Verificar branch
        run: |
          echo "ğŸ” Branch: ${{ github.ref_name }}"
          echo "ğŸ“¦ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HML_VPS_HOST }}
          username: ${{ secrets.HML_VPS_USER }}
          key: ${{ secrets.HML_VPS_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            echo "ğŸš€ Iniciando deploy em HML..."

            # Navegar para diretÃ³rio do projeto
            cd /root/obreiro-hml || exit 1

            # 1. Pull do cÃ³digo mais recente
            echo "ğŸ“¥ Baixando cÃ³digo da branch develop..."
            git fetch origin develop
            git reset --hard origin/develop

            # 2. Carregar variÃ¡veis de ambiente
            echo "ğŸ”§ Carregando variÃ¡veis de ambiente..."
            set -a
            source .env_hml
            set +a

            # 3. Rebuild dos containers backend
            echo "ğŸ”¨ Rebuilding containers backend..."
            docker-compose -f docker-compose.hml.yml build --no-cache backend_hml celery_hml celery_beat_hml

            # 4. Parar containers atuais
            echo "â¸ï¸  Parando containers..."
            docker-compose -f docker-compose.hml.yml stop backend_hml celery_hml celery_beat_hml

            # 5. Subir novos containers
            echo "â–¶ï¸  Iniciando containers atualizados..."
            docker-compose -f docker-compose.hml.yml up -d --force-recreate backend_hml celery_hml celery_beat_hml

            # 6. Aguardar containers iniciarem
            echo "â³ Aguardando containers iniciarem..."
            sleep 15

            # 7. Verificar se backend estÃ¡ rodando
            if ! docker ps | grep -q obreiro_backend_hml; then
              echo "âŒ Erro: Backend nÃ£o estÃ¡ rodando!"
              docker-compose -f docker-compose.hml.yml logs --tail=50 backend_hml
              exit 1
            fi

            # 8. Aplicar migraÃ§Ãµes
            echo "ğŸ—„ï¸  Aplicando migraÃ§Ãµes do banco de dados..."
            docker exec obreiro_backend_hml python manage.py migrate --noinput

            # 9. Coletar arquivos estÃ¡ticos
            echo "ğŸ“¦ Coletando arquivos estÃ¡ticos..."
            docker exec obreiro_backend_hml python manage.py collectstatic --noinput

            # 10. Rebuild do frontend
            echo "âš›ï¸  Rebuilding frontend..."
            docker-compose -f docker-compose.hml.yml build frontend_hml

            # 11. Executar build do frontend
            echo "ğŸ—ï¸  Executando build do frontend..."
            docker-compose -f docker-compose.hml.yml run --rm frontend_hml

            # 12. Copiar build para o host
            echo "ğŸ“‹ Copiando build do frontend para o host..."
            rm -rf /root/obreiro-hml/frontend-build/*
            docker cp obreiro_frontend_hml:/app/dist/. /root/obreiro-hml/frontend-build/ || {
              echo "âš ï¸  Tentando copiar do volume diretamente..."
              docker run --rm -v obreiro_frontend_build_hml:/source -v /root/obreiro-hml/frontend-build:/dest alpine sh -c "cp -r /source/. /dest/"
            }

            # 13. Ajustar permissÃµes
            echo "ğŸ” Ajustando permissÃµes..."
            chmod -R 755 /root/obreiro-hml/frontend-build

            # 14. Verificar arquivos do frontend
            if [ ! -f /root/obreiro-hml/frontend-build/index.html ]; then
              echo "âŒ Erro: Build do frontend nÃ£o foi copiado corretamente!"
              ls -la /root/obreiro-hml/frontend-build/
              exit 1
            fi
            echo "âœ… Frontend build copiado: $(ls -lh /root/obreiro-hml/frontend-build/ | wc -l) arquivos"

            # 15. Testar configuraÃ§Ã£o do NGINX
            echo "ğŸ” Testando configuraÃ§Ã£o do NGINX..."
            sudo nginx -t

            # 16. Recarregar NGINX
            echo "ğŸ”„ Recarregando NGINX..."
            sudo systemctl reload nginx

            # 17. Verificar status dos serviÃ§os
            echo "ğŸ“Š Status dos containers:"
            docker-compose -f docker-compose.hml.yml ps

            # 18. Health check do backend
            echo "ğŸ¥ Executando health check..."
            sleep 5

            # Verificar backend
            if curl -f -s https://hml.obreirovirtual.com/api/v1/ > /dev/null; then
              echo "âœ… Backend respondendo corretamente"
            else
              echo "âš ï¸  Backend nÃ£o estÃ¡ respondendo, verificando logs..."
              docker-compose -f docker-compose.hml.yml logs --tail=30 backend_hml
            fi

            # Verificar frontend
            if curl -f -s -I https://hml.obreirovirtual.com/ | grep -q "200 OK"; then
              echo "âœ… Frontend respondendo corretamente"
            else
              echo "âš ï¸  Frontend pode nÃ£o estar respondendo corretamente"
            fi

            # 19. Exibir Ãºltimas linhas dos logs
            echo "ğŸ“ Ãšltimos logs do backend:"
            docker-compose -f docker-compose.hml.yml logs --tail=20 backend_hml

            echo ""
            echo "âœ… Deploy concluÃ­do com sucesso!"
            echo "ğŸŒ HML disponÃ­vel em: https://hml.obreirovirtual.com"
            echo "ğŸ“… Deploy realizado em: $(date '+%Y-%m-%d %H:%M:%S')"

      - name: Enviar email de sucesso
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âœ… Deploy HML ConcluÃ­do com Sucesso - Obreiro Virtual"
          to: suporteobreirovirtual@gmail.com
          from: ${{ secrets.EMAIL_USERNAME }}
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: #28a745; color: white; padding: 20px; border-radius: 5px 5px 0 0; }
                .content { background: #f8f9fa; padding: 20px; border: 1px solid #dee2e6; }
                .footer { background: #e9ecef; padding: 15px; border-radius: 0 0 5px 5px; font-size: 12px; color: #6c757d; }
                .badge { display: inline-block; padding: 5px 10px; background: #007bff; color: white; border-radius: 3px; margin: 5px 0; }
                .link { color: #007bff; text-decoration: none; }
                table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                td { padding: 8px; border-bottom: 1px solid #dee2e6; }
                td:first-child { font-weight: bold; width: 150px; }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">
                  <h1 style="margin: 0;">âœ… Deploy ConcluÃ­do com Sucesso!</h1>
                </div>
                <div class="content">
                  <h2>ğŸ‰ Ambiente de HomologaÃ§Ã£o Atualizado</h2>
                  <p>O deploy foi realizado com sucesso no ambiente de homologaÃ§Ã£o.</p>

                  <table>
                    <tr>
                      <td>ğŸŒ Ambiente:</td>
                      <td><a href="https://hml.obreirovirtual.com" class="link">hml.obreirovirtual.com</a></td>
                    </tr>
                    <tr>
                      <td>ğŸ”€ Branch:</td>
                      <td><span class="badge">${{ github.ref_name }}</span></td>
                    </tr>
                    <tr>
                      <td>ğŸ“¦ Commit:</td>
                      <td><code>${{ github.sha }}</code></td>
                    </tr>
                    <tr>
                      <td>ğŸ‘¤ Autor:</td>
                      <td>${{ github.actor }}</td>
                    </tr>
                    <tr>
                      <td>ğŸ“… Data/Hora:</td>
                      <td>${{ github.event.head_commit.timestamp }}</td>
                    </tr>
                    <tr>
                      <td>ğŸ’¬ Mensagem:</td>
                      <td>${{ github.event.head_commit.message }}</td>
                    </tr>
                  </table>

                  <h3>ğŸ”— Links Ãšteis:</h3>
                  <ul>
                    <li><a href="https://hml.obreirovirtual.com" class="link">ğŸŒ AplicaÃ§Ã£o HML</a></li>
                    <li><a href="https://hml.obreirovirtual.com/admin" class="link">âš™ï¸ Admin Django</a></li>
                    <li><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" class="link">ğŸ“Š Logs do Deploy</a></li>
                    <li><a href="https://github.com/${{ github.repository }}/commit/${{ github.sha }}" class="link">ğŸ“ Ver Commit</a></li>
                  </ul>
                </div>
                <div class="footer">
                  <p>Deploy automÃ¡tico realizado via GitHub Actions</p>
                  <p>Workflow: ${{ github.workflow }} | Run: #${{ github.run_number }}</p>
                </div>
              </div>
            </body>
            </html>

      - name: Enviar email de falha
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âŒ FALHA no Deploy HML - Obreiro Virtual"
          to: suporteobreirovirtual@gmail.com
          from: ${{ secrets.EMAIL_USERNAME }}
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: #dc3545; color: white; padding: 20px; border-radius: 5px 5px 0 0; }
                .content { background: #f8f9fa; padding: 20px; border: 1px solid #dee2e6; }
                .footer { background: #e9ecef; padding: 15px; border-radius: 0 0 5px 5px; font-size: 12px; color: #6c757d; }
                .badge { display: inline-block; padding: 5px 10px; background: #dc3545; color: white; border-radius: 3px; margin: 5px 0; }
                .alert { background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 5px; margin: 15px 0; }
                .link { color: #007bff; text-decoration: none; }
                table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                td { padding: 8px; border-bottom: 1px solid #dee2e6; }
                td:first-child { font-weight: bold; width: 150px; }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">
                  <h1 style="margin: 0;">âŒ Deploy Falhou!</h1>
                </div>
                <div class="content">
                  <div class="alert">
                    <strong>âš ï¸ AtenÃ§Ã£o:</strong> O deploy para o ambiente de homologaÃ§Ã£o falhou e requer atenÃ§Ã£o imediata.
                  </div>

                  <h2>ğŸ“‹ Detalhes do Deploy:</h2>
                  <table>
                    <tr>
                      <td>ğŸŒ Ambiente:</td>
                      <td><span class="badge">HML</span></td>
                    </tr>
                    <tr>
                      <td>ğŸ”€ Branch:</td>
                      <td><span class="badge">${{ github.ref_name }}</span></td>
                    </tr>
                    <tr>
                      <td>ğŸ“¦ Commit:</td>
                      <td><code>${{ github.sha }}</code></td>
                    </tr>
                    <tr>
                      <td>ğŸ‘¤ Autor:</td>
                      <td>${{ github.actor }}</td>
                    </tr>
                    <tr>
                      <td>ğŸ“… Data/Hora:</td>
                      <td>${{ github.event.head_commit.timestamp }}</td>
                    </tr>
                    <tr>
                      <td>ğŸ’¬ Mensagem:</td>
                      <td>${{ github.event.head_commit.message }}</td>
                    </tr>
                  </table>

                  <h3>ğŸ” PrÃ³ximos Passos:</h3>
                  <ol>
                    <li>Verifique os logs completos do deploy no link abaixo</li>
                    <li>Identifique o erro especÃ­fico que causou a falha</li>
                    <li>Corrija o problema e faÃ§a um novo push</li>
                    <li>Se necessÃ¡rio, faÃ§a rollback para versÃ£o anterior estÃ¡vel</li>
                  </ol>

                  <h3>ğŸ”— Links Ãšteis:</h3>
                  <ul>
                    <li><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" class="link">ğŸ“Š Ver Logs Completos do Deploy</a></li>
                    <li><a href="https://github.com/${{ github.repository }}/commit/${{ github.sha }}" class="link">ğŸ“ Ver Commit que Falhou</a></li>
                    <li><a href="https://hml.obreirovirtual.com" class="link">ğŸŒ Verificar AplicaÃ§Ã£o HML</a></li>
                  </ul>
                </div>
                <div class="footer">
                  <p>Deploy automÃ¡tico realizado via GitHub Actions</p>
                  <p>Workflow: ${{ github.workflow }} | Run: #${{ github.run_number }}</p>
                </div>
              </div>
            </body>
            </html>
