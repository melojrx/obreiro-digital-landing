name: Teste SSH ProduÃ§Ã£o

on:
  workflow_dispatch:

jobs:
  test-ssh:
    name: Testar ConexÃ£o SSH PROD
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Validar secrets
        run: |
          [ -n "${{ secrets.HML_VPS_SSH_KEY }}" ] || { echo "âŒ HML_VPS_SSH_KEY vazio"; exit 1; }
          [ -n "${{ secrets.HML_VPS_HOST }}" ] || { echo "âŒ HML_VPS_HOST vazio"; exit 1; }
          [ -n "${{ secrets.HML_VPS_USER }}" ] || { echo "âŒ HML_VPS_USER vazio"; exit 1; }
          echo "âœ… Todos os secrets estÃ£o presentes (usando secrets de HML - mesma VPS)"

      - name: Teste de ConexÃ£o SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HML_VPS_HOST }}
          username: ${{ secrets.HML_VPS_USER }}
          key: ${{ secrets.HML_VPS_SSH_KEY }}
          port: 22
          command_timeout: 2m
          script: |
            echo "âœ… SSH conectado com sucesso!"
            echo "ğŸ“ Hostname: $(hostname)"
            echo "ğŸ‘¤ UsuÃ¡rio: $(whoami)"
            echo ""

            echo "ğŸ” Verificando diretÃ³rio /root/obreiro-digital-landing:"
            if [ -d /root/obreiro-digital-landing ]; then
              echo "âœ… DiretÃ³rio existe"
              cd /root/obreiro-digital-landing
              echo "ğŸ“‚ Branch atual: $(git branch --show-current)"
              echo "ğŸ“ Arquivos .env:"
              ls -la .env* 2>/dev/null || echo "Nenhum arquivo .env* encontrado"
              echo ""
              echo "ğŸ³ Docker containers ativos:"
              docker ps --format "table {{.Names}}\t{{.Status}}" | grep obreiro || echo "Nenhum container obreiro rodando"
            else
              echo "âŒ DiretÃ³rio /root/obreiro-digital-landing NÃƒO existe!"
              echo "ğŸ“‚ ConteÃºdo de /root/:"
              ls -la /root/ | grep obreiro
              exit 1
            fi
