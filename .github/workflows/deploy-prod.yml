name: Deploy para Produ√ß√£o

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Pular testes (use com cautela)'
        required: false
        type: boolean
        default: false

jobs:
  deploy-prod:
    name: Deploy para PRODU√á√ÉO
    runs-on: ubuntu-latest
    # S√≥ executa se for push direto OU se o PR foi mergeado (n√£o apenas fechado)
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    environment:
      name: production
      url: https://www.obreirovirtual.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Verificar branch
        run: |
          echo "üöÄ DEPLOY PARA PRODU√á√ÉO üöÄ"
          echo "üîç Branch: ${{ github.ref_name }}"
          echo "üì¶ Commit: ${{ github.sha }}"
          echo "üë§ Author: ${{ github.actor }}"
          echo "üéØ Event: ${{ github.event_name }}"

      - name: Validar secrets de produ√ß√£o
        run: |
          [ -n "${{ secrets.PROD_VPS_SSH_KEY }}" ] || { echo "‚ùå Secret PROD_VPS_SSH_KEY ausente ou vazio"; exit 1; }
          [ -n "${{ secrets.PROD_VPS_HOST }}" ] || { echo "‚ùå Secret PROD_VPS_HOST ausente ou vazio"; exit 1; }
          [ -n "${{ secrets.PROD_VPS_USER }}" ] || { echo "‚ùå Secret PROD_VPS_USER ausente ou vazio"; exit 1; }
          echo "‚úÖ Secrets de produ√ß√£o encontrados"

      - name: Preparar chave SSH de produ√ß√£o
        run: |
          KEY_PATH="$GITHUB_WORKSPACE/.ssh_prod_key"
          printf '%s' "${{ secrets.PROD_VPS_SSH_KEY }}" | sed 's/^[[:space:]]\+//' > "$KEY_PATH"
          chmod 600 "$KEY_PATH"
          ssh-keygen -lf "$KEY_PATH"
          echo "KEY_PATH=$KEY_PATH" >> "$GITHUB_ENV"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_VPS_HOST }}
          username: ${{ secrets.PROD_VPS_USER }}
          key_path: ${{ env.KEY_PATH }}
          port: 22
          command_timeout: 30m
          script: |
            echo "üöÄ Iniciando deploy em PRODU√á√ÉO..."
            echo "‚ö†Ô∏è  ATEN√á√ÉO: Deploy em ambiente de PRODU√á√ÉO!"

            # Navegar para diret√≥rio do projeto
            cd /root/obreiro-prod || exit 1

            # 1. Pull do c√≥digo mais recente
            echo "üì• Baixando c√≥digo da branch main..."
            git fetch origin main
            git reset --hard origin/main

            # 2. Carregar vari√°veis de ambiente
            echo "üîß Carregando vari√°veis de ambiente de PRODU√á√ÉO..."
            set -a
            source .env_prod
            set +a

            # 3. Backup do banco de dados antes do deploy
            echo "üíæ Criando backup do banco de dados..."
            BACKUP_FILE="backup_prod_$(date +%Y%m%d_%H%M%S).sql"
            docker exec obreiro_postgres_prod pg_dump -U obreiro_prod obreiro_prod > /root/backups/$BACKUP_FILE || echo "‚ö†Ô∏è  Backup falhou, mas continuando..."
            echo "‚úÖ Backup salvo: $BACKUP_FILE"

            # 4. Rebuild dos containers backend
            echo "üî® Rebuilding containers backend..."
            docker-compose -f docker-compose.prod.yml build --no-cache backend celery celery-beat

            # 5. Parar containers atuais (exceto postgres e redis)
            echo "‚è∏Ô∏è  Parando containers backend..."
            docker-compose -f docker-compose.prod.yml stop backend celery celery-beat

            # 6. Subir novos containers
            echo "‚ñ∂Ô∏è  Iniciando containers atualizados..."
            docker-compose -f docker-compose.prod.yml up -d --force-recreate backend celery celery-beat

            # 7. Aguardar containers iniciarem
            echo "‚è≥ Aguardando containers iniciarem..."
            sleep 20

            # 8. Verificar se backend est√° rodando
            if ! docker ps | grep -q obreiro_backend_prod; then
              echo "‚ùå ERRO CR√çTICO: Backend n√£o est√° rodando!"
              docker-compose -f docker-compose.prod.yml logs --tail=50 backend
              echo "üîÑ Tentando restaurar vers√£o anterior..."
              exit 1
            fi

            # 9. Aplicar migra√ß√µes
            echo "üóÑÔ∏è  Aplicando migra√ß√µes do banco de dados..."
            docker exec obreiro_backend_prod python manage.py migrate --noinput || {
              echo "‚ùå ERRO: Migra√ß√µes falharam!"
              echo "üìã Logs do backend:"
              docker-compose -f docker-compose.prod.yml logs --tail=50 backend
              exit 1
            }

            # 10. Coletar arquivos est√°ticos
            echo "üì¶ Coletando arquivos est√°ticos..."
            docker exec obreiro_backend_prod python manage.py collectstatic --noinput

            # 11. Rebuild do frontend
            echo "‚öõÔ∏è  Rebuilding frontend de PRODU√á√ÉO..."
            docker-compose -f docker-compose.prod.yml build --no-cache frontend-build

            # 12. Executar build do frontend
            echo "üèóÔ∏è  Executando build do frontend..."
            docker-compose -f docker-compose.prod.yml up frontend-build

            # 13. Copiar build para o diret√≥rio tempor√°rio no host
            echo "üìã Copiando build do frontend para o host..."
            rm -rf /root/obreiro-prod/frontend_build/*
            docker cp obreiro_frontend_build:/app/dist/. /root/obreiro-prod/frontend_build/ || {
              echo "‚ö†Ô∏è  Tentando copiar do volume diretamente..."
              docker run --rm -v obreiro_frontend_build_prod:/source -v /root/obreiro-prod/frontend_build:/dest alpine sh -c "cp -r /source/. /dest/" || exit 1
            }

            # 14. Ajustar permiss√µes
            echo "üîê Ajustando permiss√µes..."
            chmod -R 755 /root/obreiro-prod/frontend_build

            # 15. Copiar frontend para diret√≥rio do nginx
            echo "üì¶ Copiando frontend para /var/www/html/prod/..."
            sudo mkdir -p /var/www/html/prod

            # Criar backup do frontend antigo
            if [ -d /var/www/html/prod ] && [ "$(ls -A /var/www/html/prod)" ]; then
              echo "üíæ Criando backup do frontend anterior..."
              sudo cp -r /var/www/html/prod /var/www/html/prod_backup_$(date +%Y%m%d_%H%M%S) || echo "‚ö†Ô∏è  Backup do frontend falhou"
            fi

            # Copiar novo frontend
            sudo cp -r /root/obreiro-prod/frontend_build/* /var/www/html/prod/
            sudo chmod -R 755 /var/www/html/prod

            # 16. Verificar arquivos do frontend
            if [ ! -f /var/www/html/prod/index.html ]; then
              echo "‚ùå ERRO CR√çTICO: Frontend n√£o foi copiado para /var/www/html/prod/!"
              ls -la /var/www/html/prod/
              exit 1
            fi
            echo "‚úÖ Frontend dispon√≠vel em /var/www/html/prod/: $(ls -lh /var/www/html/prod/ | wc -l) arquivos"

            # 17. Testar configura√ß√£o do NGINX
            echo "üîç Testando configura√ß√£o do NGINX..."
            sudo nginx -t || {
              echo "‚ùå ERRO: Configura√ß√£o do nginx inv√°lida!"
              exit 1
            }

            # 18. Recarregar NGINX
            echo "üîÑ Recarregando NGINX..."
            sudo systemctl reload nginx

            # 19. Verificar status dos servi√ßos
            echo "üìä Status dos containers:"
            docker-compose -f docker-compose.prod.yml ps

            # 20. Health check completo
            echo "üè• Executando health check..."
            sleep 10

            # Verificar backend
            BACKEND_CHECK=$(curl -f -s https://www.obreirovirtual.com/api/v1/ && echo "OK" || echo "FAIL")
            if [ "$BACKEND_CHECK" = "OK" ]; then
              echo "‚úÖ Backend respondendo corretamente"
            else
              echo "‚ùå ERRO CR√çTICO: Backend n√£o est√° respondendo!"
              docker-compose -f docker-compose.prod.yml logs --tail=50 backend
              exit 1
            fi

            # Verificar frontend
            FRONTEND_CHECK=$(curl -f -s -I https://www.obreirovirtual.com/ | grep -q "200 OK" && echo "OK" || echo "FAIL")
            if [ "$FRONTEND_CHECK" = "OK" ]; then
              echo "‚úÖ Frontend respondendo corretamente"
            else
              echo "‚ö†Ô∏è  Frontend pode n√£o estar respondendo corretamente"
              echo "üìã Verificando logs do nginx..."
              sudo tail -n 30 /var/log/nginx/error.log
            fi

            # 21. Limpar containers e imagens antigas
            echo "üßπ Limpando containers e imagens antigas..."
            docker system prune -f --volumes || echo "‚ö†Ô∏è  Limpeza parcial"

            # 22. Exibir √∫ltimas linhas dos logs
            echo "üìù √öltimos logs do backend:"
            docker-compose -f docker-compose.prod.yml logs --tail=20 backend

            echo ""
            echo "‚úÖ =========================================="
            echo "‚úÖ DEPLOY EM PRODU√á√ÉO CONCLU√çDO COM SUCESSO!"
            echo "‚úÖ =========================================="
            echo "üåê Produ√ß√£o dispon√≠vel em: https://www.obreirovirtual.com"
            echo "üìÖ Deploy realizado em: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "üì¶ Commit: ${{ github.sha }}"
            echo "üë§ Autor: ${{ github.actor }}"

      - name: Enviar email de sucesso
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚úÖ Deploy PRODU√á√ÉO Conclu√≠do com Sucesso - Obreiro Virtual"
          to: suporteobreirovirtual@gmail.com,jrmeloafrf@gmail.com
          from: ${{ secrets.EMAIL_USERNAME }}
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 30px; border-radius: 5px 5px 0 0; text-align: center; }
                .content { background: #f8f9fa; padding: 30px; border: 1px solid #dee2e6; }
                .footer { background: #e9ecef; padding: 15px; border-radius: 0 0 5px 5px; font-size: 12px; color: #6c757d; text-align: center; }
                .badge { display: inline-block; padding: 5px 10px; background: #007bff; color: white; border-radius: 3px; margin: 5px 0; }
                .badge-prod { background: #28a745; font-weight: bold; }
                .link { color: #007bff; text-decoration: none; }
                .alert-success { background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px; margin: 15px 0; color: #155724; }
                table { width: 100%; border-collapse: collapse; margin: 15px 0; background: white; }
                td { padding: 12px; border-bottom: 1px solid #dee2e6; }
                td:first-child { font-weight: bold; width: 150px; background: #f8f9fa; }
                h1 { margin: 0; font-size: 28px; }
                h2 { color: #28a745; border-bottom: 2px solid #28a745; padding-bottom: 10px; }
                .highlight { background: #fff3cd; padding: 10px; border-left: 4px solid #ffc107; margin: 10px 0; }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">
                  <h1>üöÄ Deploy em PRODU√á√ÉO</h1>
                  <h2 style="margin: 10px 0 0 0; font-weight: normal; color: #e8f5e9;">Conclu√≠do com Sucesso!</h2>
                </div>
                <div class="content">
                  <div class="alert-success">
                    <strong>‚úÖ Deploy realizado com sucesso!</strong><br>
                    A aplica√ß√£o est√° dispon√≠vel e respondendo corretamente em produ√ß√£o.
                  </div>

                  <h2>üìã Detalhes do Deploy</h2>
                  <table>
                    <tr>
                      <td>üåê Ambiente:</td>
                      <td><span class="badge badge-prod">PRODU√á√ÉO</span></td>
                    </tr>
                    <tr>
                      <td>üîó URL:</td>
                      <td><a href="https://www.obreirovirtual.com" class="link">www.obreirovirtual.com</a></td>
                    </tr>
                    <tr>
                      <td>üîÄ Branch:</td>
                      <td><span class="badge">${{ github.ref_name }}</span></td>
                    </tr>
                    <tr>
                      <td>üì¶ Commit:</td>
                      <td><code>${{ github.sha }}</code></td>
                    </tr>
                    <tr>
                      <td>üë§ Autor:</td>
                      <td>${{ github.actor }}</td>
                    </tr>
                    <tr>
                      <td>üìÖ Data/Hora:</td>
                      <td>${{ github.event.head_commit.timestamp }}</td>
                    </tr>
                    <tr>
                      <td>üí¨ Mensagem:</td>
                      <td>${{ github.event.head_commit.message }}</td>
                    </tr>
                  </table>

                  <div class="highlight">
                    <strong>‚ö†Ô∏è A√ß√µes Realizadas:</strong>
                    <ul style="margin: 10px 0;">
                      <li>‚úÖ Backup do banco de dados criado</li>
                      <li>‚úÖ Backend atualizado e migra√ß√µes aplicadas</li>
                      <li>‚úÖ Frontend buildado e publicado</li>
                      <li>‚úÖ Nginx recarregado</li>
                      <li>‚úÖ Health checks passaram</li>
                    </ul>
                  </div>

                  <h2>üîó Links √öteis</h2>
                  <ul>
                    <li><a href="https://www.obreirovirtual.com" class="link">üåê Aplica√ß√£o PRODU√á√ÉO</a></li>
                    <li><a href="https://www.obreirovirtual.com/admin" class="link">‚öôÔ∏è Admin Django</a></li>
                    <li><a href="https://www.obreirovirtual.com/api/v1/" class="link">üîå API Backend</a></li>
                    <li><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" class="link">üìä Logs do Deploy</a></li>
                    <li><a href="https://github.com/${{ github.repository }}/commit/${{ github.sha }}" class="link">üìù Ver Commit</a></li>
                  </ul>

                  <h2>üìà Pr√≥ximos Passos</h2>
                  <ol>
                    <li>Monitore os logs da aplica√ß√£o por alguns minutos</li>
                    <li>Verifique se n√£o h√° erros no console do navegador</li>
                    <li>Teste as funcionalidades principais</li>
                    <li>Monitore m√©tricas de performance</li>
                  </ol>
                </div>
                <div class="footer">
                  <p><strong>Deploy autom√°tico realizado via GitHub Actions</strong></p>
                  <p>Workflow: ${{ github.workflow }} | Run: #${{ github.run_number }}</p>
                  <p style="margin-top: 10px; color: #28a745;">
                    <strong>Autor:</strong> Junior Melo (jrmeloafrf@gmail.com)
                  </p>
                </div>
              </div>
            </body>
            </html>

      - name: Enviar email de falha
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üö® FALHA CR√çTICA no Deploy PRODU√á√ÉO - Obreiro Virtual"
          to: suporteobreirovirtual@gmail.com,jrmeloafrf@gmail.com
          from: ${{ secrets.EMAIL_USERNAME }}
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; padding: 30px; border-radius: 5px 5px 0 0; text-align: center; }
                .content { background: #f8f9fa; padding: 30px; border: 1px solid #dee2e6; }
                .footer { background: #e9ecef; padding: 15px; border-radius: 0 0 5px 5px; font-size: 12px; color: #6c757d; text-align: center; }
                .badge { display: inline-block; padding: 5px 10px; background: #dc3545; color: white; border-radius: 3px; margin: 5px 0; font-weight: bold; }
                .alert { background: #f8d7da; border: 2px solid #f5c6cb; padding: 20px; border-radius: 5px; margin: 15px 0; color: #721c24; }
                .link { color: #007bff; text-decoration: none; }
                table { width: 100%; border-collapse: collapse; margin: 15px 0; background: white; }
                td { padding: 12px; border-bottom: 1px solid #dee2e6; }
                td:first-child { font-weight: bold; width: 150px; background: #f8f9fa; }
                h1 { margin: 0; font-size: 28px; }
                h2 { color: #dc3545; border-bottom: 2px solid #dc3545; padding-bottom: 10px; }
                .urgent { background: #fff3cd; padding: 15px; border-left: 4px solid #dc3545; margin: 15px 0; }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">
                  <h1>üö® FALHA NO DEPLOY</h1>
                  <h2 style="margin: 10px 0 0 0; font-weight: normal; color: #ffebee;">Ambiente de PRODU√á√ÉO</h2>
                </div>
                <div class="content">
                  <div class="alert">
                    <strong>‚ö†Ô∏è ATEN√á√ÉO URGENTE:</strong><br>
                    O deploy para o ambiente de PRODU√á√ÉO falhou e requer aten√ß√£o imediata!<br>
                    <strong>A aplica√ß√£o pode estar inst√°vel ou indispon√≠vel.</strong>
                  </div>

                  <div class="urgent">
                    <strong>üö® A√á√ÉO IMEDIATA NECESS√ÅRIA!</strong>
                    <p style="margin: 5px 0;">Verifique imediatamente se a aplica√ß√£o est√° respondendo e considere fazer rollback se necess√°rio.</p>
                  </div>

                  <h2>üìã Detalhes do Deploy Falho</h2>
                  <table>
                    <tr>
                      <td>üåê Ambiente:</td>
                      <td><span class="badge">PRODU√á√ÉO</span></td>
                    </tr>
                    <tr>
                      <td>üîÄ Branch:</td>
                      <td><span class="badge">${{ github.ref_name }}</span></td>
                    </tr>
                    <tr>
                      <td>üì¶ Commit:</td>
                      <td><code>${{ github.sha }}</code></td>
                    </tr>
                    <tr>
                      <td>üë§ Autor:</td>
                      <td>${{ github.actor }}</td>
                    </tr>
                    <tr>
                      <td>üìÖ Data/Hora:</td>
                      <td>${{ github.event.head_commit.timestamp }}</td>
                    </tr>
                    <tr>
                      <td>üí¨ Mensagem:</td>
                      <td>${{ github.event.head_commit.message }}</td>
                    </tr>
                  </table>

                  <h2>üîç Pr√≥ximos Passos URGENTES</h2>
                  <ol>
                    <li><strong>Verificar se a aplica√ß√£o est√° online:</strong> <a href="https://www.obreirovirtual.com" class="link">www.obreirovirtual.com</a></li>
                    <li><strong>Revisar logs completos do deploy</strong> no link abaixo</li>
                    <li><strong>Identificar o erro espec√≠fico</strong> que causou a falha</li>
                    <li><strong>Considerar ROLLBACK</strong> para vers√£o anterior est√°vel se necess√°rio</li>
                    <li><strong>Corrigir o problema</strong> antes de tentar novo deploy</li>
                  </ol>

                  <h2>üîß Como fazer Rollback</h2>
                  <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto;">
                    ssh root@VPS_HOST
                    cd /root/obreiro-prod
                    git log --oneline -5
                    git reset --hard COMMIT_ANTERIOR
                    docker-compose -f docker-compose.prod.yml restart
                  </pre>

                  <h2>üîó Links √öteis</h2>
                  <ul>
                    <li><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" class="link"><strong>üìä Ver Logs Completos do Deploy</strong></a></li>
                    <li><a href="https://github.com/${{ github.repository }}/commit/${{ github.sha }}" class="link">üìù Ver Commit que Falhou</a></li>
                    <li><a href="https://www.obreirovirtual.com" class="link">üåê Verificar Aplica√ß√£o PRODU√á√ÉO</a></li>
                  </ul>
                </div>
                <div class="footer">
                  <p><strong>Deploy autom√°tico realizado via GitHub Actions</strong></p>
                  <p>Workflow: ${{ github.workflow }} | Run: #${{ github.run_number }}</p>
                  <p style="margin-top: 10px; color: #dc3545;">
                    <strong>Contato:</strong> Junior Melo (jrmeloafrf@gmail.com)
                  </p>
                </div>
              </div>
            </body>
            </html>
